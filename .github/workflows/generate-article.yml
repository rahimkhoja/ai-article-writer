name: Generate Article from YouTube Transcripts

on:
  workflow_dispatch:
    inputs:
      youtube_url_1:
        description: 'YouTube URL 1'
        required: true
        type: string
      youtube_url_2:
        description: 'YouTube URL 2 (optional)'
        required: false
        type: string
      youtube_url_3:
        description: 'YouTube URL 3 (optional)'
        required: false
        type: string
      youtube_url_4:
        description: 'YouTube URL 4 (optional)'
        required: false
        type: string
      youtube_url_5:
        description: 'YouTube URL 5 (optional)'
        required: false
        type: string
      youtube_url_6:
        description: 'YouTube URL 6 (optional)'
        required: false
        type: string
      youtube_url_7:
        description: 'YouTube URL 7 (optional)'
        required: false
        type: string
      youtube_url_8:
        description: 'YouTube URL 8 (optional)'
        required: false
        type: string
      youtube_url_9:
        description: 'YouTube URL 9 (optional)'
        required: false
        type: string
      youtube_url_10:
        description: 'YouTube URL 10 (optional)'
        required: false
        type: string
      context_message:
        description: 'Context/Message about what the article should be about (optional)'
        required: false
        type: string
      additional_info:
        description: 'Additional information about the subject (can include links for AI to review) (optional)'
        required: false
        type: string
      article_type:
        description: 'Type of article/post to generate'
        required: false
        type: choice
        options:
          - LinkedIn Article
          - LinkedIn Post
          - Substack
          - Reddit Post
          - Blog Post
          - Twitter Thread
        default: LinkedIn Article
      word_count:
        description: 'Target word count'
        required: false
        type: choice
        options:
          - '500'
          - '1000'
          - '1500'
          - '2000'
          - '2500'
          - '3000'
        default: '1000'
      audience:
        description: 'Target audience'
        required: false
        type: choice
        options:
          - Senior engineers and technical practitioners
          - Software developers and engineers
          - Product managers and business leaders
          - Data scientists and ML engineers
          - DevOps and infrastructure engineers
          - General tech audience
          - Students and beginners
        default: Senior engineers and technical practitioners
      enable_research:
        description: 'Enable additional research via Google Search'
        required: false
        type: boolean
        default: true

jobs:
  generate:
    runs-on: self-hosted
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Set up Python and venv
        run: |
          # Detect available Python version (try python3.11, python3.10, python3, python)
          if command -v python3.11 &> /dev/null; then
            PYTHON_CMD=python3.11
          elif command -v python3.10 &> /dev/null; then
            PYTHON_CMD=python3.10
          elif command -v python3 &> /dev/null; then
            PYTHON_CMD=python3
          elif command -v python &> /dev/null; then
            PYTHON_CMD=python
          else
            echo "Error: No Python installation found"
            exit 1
          fi
          
          echo "Using Python: $($PYTHON_CMD --version)"
          echo "PYTHON_CMD=$PYTHON_CMD" >> $GITHUB_ENV
          
          # Check if venv module is available
          if ! $PYTHON_CMD -c "import venv" 2>/dev/null; then
            echo "venv module not available, installing python3-venv..."
            if command -v apt-get &> /dev/null; then
              sudo apt-get update -qq
              sudo apt-get install -y python3-venv
            elif command -v yum &> /dev/null; then
              sudo yum install -y python3-venv
            else
              echo "Error: Cannot install python3-venv. Please install it manually."
              exit 1
            fi
          fi
          
          # Create virtual environment
          echo "Creating virtual environment..."
          $PYTHON_CMD -m venv venv
          
          # Verify venv was created
          if [ ! -f "./venv/bin/python" ]; then
            echo "Error: Virtual environment creation failed"
            exit 1
          fi
          
          echo "Virtual environment created successfully"
          
          # Upgrade pip (use venv's python directly)
          ./venv/bin/python -m pip install --upgrade pip

      - name: üì¶ Install dependencies
        run: |
          ./venv/bin/pip install -r requirements.txt

      - name: üìù Generate article from transcripts
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ./venv/bin/python scripts/generate_article.py \
            --url-1 "${{ inputs.youtube_url_1 }}" \
            --url-2 "${{ inputs.youtube_url_2 }}" \
            --url-3 "${{ inputs.youtube_url_3 }}" \
            --url-4 "${{ inputs.youtube_url_4 }}" \
            --url-5 "${{ inputs.youtube_url_5 }}" \
            --url-6 "${{ inputs.youtube_url_6 }}" \
            --url-7 "${{ inputs.youtube_url_7 }}" \
            --url-8 "${{ inputs.youtube_url_8 }}" \
            --url-9 "${{ inputs.youtube_url_9 }}" \
            --url-10 "${{ inputs.youtube_url_10 }}" \
            --context "${{ inputs.context_message }}" \
            --additional-info "${{ inputs.additional_info }}" \
            --article-type "${{ inputs.article_type }}" \
            --word-count "${{ inputs.word_count }}" \
            --audience "${{ inputs.audience }}" \
            --enable-research "${{ inputs.enable_research }}"

      - name: üì§ Commit and Push Article
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure git to use the token for authentication
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Add the generated article
          git add articles/
          
          # Check if there are staged changes before committing
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Add generated article from YouTube transcripts"
            git push origin HEAD:${{ github.ref_name }}
          fi
